<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>バーチャル純喫茶</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        body {
            font-family: 'Georgia', serif;
            overflow: hidden;
            background: #8B4513;
        }
        #game-container {
            width: 100vw;
            height: 100vh;
            display: block;
        }
        canvas {
            display: block;
            margin: 0 auto;
        }
        .ui-overlay {
            position: absolute;
            top: 10px;
            left: 10px;
            background: rgba(139, 69, 19, 0.8);
            color: #F5DEB3;
            padding: 10px;
            border-radius: 5px;
            font-size: 12px;
            z-index: 1000;
            pointer-events: none;
        }
        .controls-hint {
            position: absolute;
            bottom: 10px;
            right: 10px;
            background: rgba(139, 69, 19, 0.8);
            color: #F5DEB3;
            padding: 8px;
            border-radius: 5px;
            font-size: 11px;
            z-index: 1000;
            pointer-events: none;
        }
    </style>
</head>
<body>
    <div class="ui-overlay">
        <div>☕ 純喫茶「憩」</div>
        <div>お客様: <span id="customer-count">1</span>名</div>
    </div>
    
    <div class="controls-hint">
        矢印キー: 移動
    </div>
    
    <!-- Phaser.jsをCDNから読み込み -->
    <script src="https://cdn.jsdelivr.net/npm/phaser@3.70.0/dist/phaser.min.js"></script>
    
    <script type="module">
        // Firebase の設定と初期化
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.0.1/firebase-app.js";
        import { getDatabase, ref, set, onValue, push } from "https://www.gstatic.com/firebasejs/11.0.1/firebase-database.js";
        
        // Firebase設定
        const firebaseConfig = {
            apiKey: "AIzaSyA4i0HfjD3Bxnv80TCm7icQ6e20jss1ATs",
            authDomain: "virtual-office-40ff8.firebaseapp.com",
            databaseURL: "https://virtual-office-40ff8-default-rtdb.asia-southeast1.firebasedatabase.app",
            projectId: "virtual-office-40ff8",
            storageBucket: "virtual-office-40ff8.firebasestorage.app",
            messagingSenderId: "113452355413",
            appId: "1:113452355413:web:1e35e9d49282710171e9dc"
        };

        // Firebaseを初期化
        const app = initializeApp(firebaseConfig);
        const database = getDatabase(app);
        
        // レスポンシブなゲーム設定
        const gameWidth = window.innerWidth;
        const gameHeight = window.innerHeight;
        
        const config = {
            type: Phaser.AUTO,
            width: gameWidth,
            height: gameHeight,
            backgroundColor: '#DEB887',
            parent: 'game-container',
            scale: {
                mode: Phaser.Scale.RESIZE,
                autoCenter: Phaser.Scale.CENTER_BOTH
            },
            scene: {
                preload: preload,
                create: create,
                update: update,
                resize: resize
            }
        };

        let player;
        let cursors;
        let otherPlayers = {};
        let playerId;
        let gameScene;

        function preload() {
            gameScene = this;
            
            // 俯瞰視点用のアバター（上から見た人の形）
            this.add.graphics()
                .fillStyle(0xFFDBB3) // 肌色（頭）
                .fillCircle(16, 12, 8)
                .fillStyle(0x8B4513) // 茶色の服（体）
                .fillEllipse(16, 28, 16, 20)
                .fillStyle(0x654321) // 髪
                .fillCircle(16, 10, 9)
                .generateTexture('customer-top-1', 32, 40);
                
            this.add.graphics()
                .fillStyle(0xFFDBB3)
                .fillCircle(16, 12, 8)
                .fillStyle(0x2F4F2F) // 深緑の服
                .fillEllipse(16, 28, 16, 20)
                .fillStyle(0x8B4513) // 茶髪
                .fillCircle(16, 10, 9)
                .generateTexture('customer-top-2', 32, 40);
                
            this.add.graphics()
                .fillStyle(0xFFDBB3)
                .fillCircle(16, 12, 8)
                .fillStyle(0x483D8B) // 紺色の服
                .fillEllipse(16, 28, 16, 20)
                .fillStyle(0x2F2F2F) // 黒髪
                .fillCircle(16, 10, 9)
                .generateTexture('customer-top-3', 32, 40);
                
            this.add.graphics()
                .fillStyle(0xFFDBB3)
                .fillCircle(16, 12, 8)
                .fillStyle(0xB22222) // えんじ色の服
                .fillEllipse(16, 28, 16, 20)
                .fillStyle(0x654321)
                .fillCircle(16, 10, 9)
                .generateTexture('customer-top-4', 32, 40);

            // 俯瞰視点用の家具
            // テーブル（上から見た円形）
            this.add.graphics()
                .fillStyle(0x8B4513) // 木の縁
                .fillCircle(40, 40, 35)
                .fillStyle(0xF5DEB3) // テーブル表面
                .fillCircle(40, 40, 30)
                .fillStyle(0xE6E6FA) // ハイライト
                .fillCircle(35, 35, 25)
                .generateTexture('table-top', 80, 80);

            // 椅子（上から見た四角）
            this.add.graphics()
                .fillStyle(0x8B4513) // 木の枠
                .fillRect(5, 5, 30, 30)
                .fillStyle(0xDC143C) // 赤いクッション
                .fillRect(8, 8, 24, 24)
                .fillStyle(0xB22222) // 影
                .fillRect(10, 26, 20, 6)
                .generateTexture('chair-top', 40, 40);

            // カウンター（長方形）
            this.add.graphics()
                .fillStyle(0x8B4513)
                .fillRect(0, 0, 300, 80)
                .fillStyle(0xA0522D)
                .fillRect(5, 5, 290, 70)
                .fillStyle(0xCD853F)
                .fillRect(10, 10, 280, 60)
                .generateTexture('counter-top', 300, 80);

            // 観葉植物（上から見た円形）
            this.add.graphics()
                .fillStyle(0x8B4513) // 鉢
                .fillCircle(20, 20, 15)
                .fillStyle(0x228B22) // 葉
                .fillCircle(20, 20, 12)
                .fillStyle(0x32CD32)
                .fillCircle(20, 20, 8)
                .generateTexture('plant-top', 40, 40);

            // コーヒーカップ（小さな円）
            this.add.graphics()
                .fillStyle(0xFFFFFF)
                .fillCircle(6, 6, 5)
                .fillStyle(0x8B4513)
                .fillCircle(6, 6, 3)
                .generateTexture('cup-top', 12, 12);
        }

        function create() {
            // 画面サイズに応じて喫茶店を作成
            this.createCafeTopDown();
            
            playerId = 'player_' + Math.random().toString(36).substr(2, 9);
            
            const customerTypes = ['customer-top-1', 'customer-top-2', 'customer-top-3', 'customer-top-4'];
            const playerType = customerTypes[Math.floor(Math.random() * customerTypes.length)];
            
            // プレイヤーを画面中央に配置
            player = this.add.sprite(gameWidth / 2, gameHeight / 2, playerType);
            player.playerId = playerId;
            player.playerType = playerType;
            player.setDepth(100);
            
            cursors = this.input.keyboard.createCursorKeys();
            
            // Firebaseでプレイヤー監視
            const playersRef = ref(database, 'players');
            onValue(playersRef, (snapshot) => {
                const players = snapshot.val();
                const playerCount = players ? Object.keys(players).length : 1;
                document.getElementById('customer-count').textContent = playerCount;
                
                if (players) {
                    Object.keys(players).forEach(id => {
                        if (id !== playerId) {
                            updateOtherPlayer.call(this, id, players[id]);
                        }
                    });
                    
                    Object.keys(otherPlayers).forEach(id => {
                        if (!players[id]) {
                            if (otherPlayers[id]) {
                                otherPlayers[id].destroy();
                                if (otherPlayers[id].shadowCircle) {
                                    otherPlayers[id].shadowCircle.destroy();
                                }
                                delete otherPlayers[id];
                            }
                        }
                    });
                }
            });
        }

        function resize(gameSize) {
            const width = gameSize.width;
            const height = gameSize.height;
            
            this.cameras.resize(width, height);
        }

        // 俯瞰視点の喫茶店を作成
        Phaser.Scene.prototype.createCafeTopDown = function() {
            const centerX = gameWidth / 2;
            const centerY = gameHeight / 2;
            
            // ベースの床（木目調）
            this.add.rectangle(centerX, centerY, gameWidth, gameHeight, 0xDEB887);
            
            // 床の木目パターン
            for (let i = 0; i < gameWidth; i += 150) {
                this.add.line(i + 75, centerY, 0, 0, 0, gameHeight, 0xCD853F, 0.2).setOrigin(0.5, 0.5);
            }
            for (let i = 0; i < gameHeight; i += 100) {
                this.add.line(centerX, i + 50, 0, 0, gameWidth, 0, 0xCD853F, 0.15).setOrigin(0.5, 0.5);
            }
            
            // カウンター（上部中央）
            this.add.image(centerX, 120, 'counter-top').setDepth(1);
            
            // テーブル配置（レスポンシブ）
            const tableSpacing = 180;
            const startX = Math.max(150, (gameWidth - tableSpacing * 4) / 2);
            const startY = Math.max(250, centerY - 100);
            
            // 3x2のテーブル配置
            for (let row = 0; row < 2; row++) {
                for (let col = 0; col < 3; col++) {
                    const x = startX + col * tableSpacing;
                    const y = startY + row * tableSpacing;
                    
                    if (x < gameWidth - 100 && y < gameHeight - 100) {
                        // テーブル
                        this.add.image(x, y, 'table-top').setDepth(1);
                        
                        // 椅子を4方向に配置
                        this.add.image(x - 50, y, 'chair-top').setDepth(2);
                        this.add.image(x + 50, y, 'chair-top').setDepth(2);
                        this.add.image(x, y - 50, 'chair-top').setDepth(2);
                        this.add.image(x, y + 50, 'chair-top').setDepth(2);
                        
                        // コーヒーカップ
                        if (Math.random() > 0.5) {
                            this.add.image(x + (Math.random() - 0.5) * 30, y + (Math.random() - 0.5) * 30, 'cup-top').setDepth(3);
                        }
                    }
                }
            }
            
            // 観葉植物を四隅に
            if (gameWidth > 400 && gameHeight > 300) {
                this.add.image(80, 80, 'plant-top').setDepth(1);
                this.add.image(gameWidth - 80, 80, 'plant-top').setDepth(1);
                this.add.image(80, gameHeight - 80, 'plant-top').setDepth(1);
                this.add.image(gameWidth - 80, gameHeight - 80, 'plant-top').setDepth(1);
            }
            
            // 壁の表現（薄い線）
            this.add.rectangle(centerX, 10, gameWidth - 20, 5, 0x8B4513, 0.6);
            this.add.rectangle(centerX, gameHeight - 10, gameWidth - 20, 5, 0x8B4513, 0.6);
            this.add.rectangle(10, centerY, 5, gameHeight - 20, 0x8B4513, 0.6);
            this.add.rectangle(gameWidth - 10, centerY, 5, gameHeight - 20, 0x8B4513, 0.6);
        };

        function updateOtherPlayer(id, data) {
            if (!otherPlayers[id]) {
                otherPlayers[id] = this.add.sprite(data.x, data.y, data.type || 'customer-top-1');
                otherPlayers[id].setAlpha(0.9);
                otherPlayers[id].setDepth(100);
                
                // 足元の影
                const shadowCircle = this.add.circle(data.x, data.y + 15, 10, 0x000000, 0.15);
                shadowCircle.setDepth(50);
                otherPlayers[id].shadowCircle = shadowCircle;
                
            } else {
                otherPlayers[id].x = data.x;
                otherPlayers[id].y = data.y;
                if (otherPlayers[id].shadowCircle) {
                    otherPlayers[id].shadowCircle.x = data.x;
                    otherPlayers[id].shadowCircle.y = data.y + 15;
                }
            }
        }

        function update() {
            const speed = 2.5;
            let moved = false;
            
            if (cursors.left.isDown) {
                player.x -= speed;
                moved = true;
            }
            if (cursors.right.isDown) {
                player.x += speed;
                moved = true;
            }
            if (cursors.up.isDown) {
                player.y -= speed;
                moved = true;
            }
            if (cursors.down.isDown) {
                player.y += speed;
                moved = true;
            }
            
            // 画面境界の制限
            player.x = Phaser.Math.Clamp(player.x, 30, gameWidth - 30);
            player.y = Phaser.Math.Clamp(player.y, 30, gameHeight - 30);
            
            if (moved) {
                const playerRef = ref(database, 'players/' + playerId);
                set(playerRef, {
                    x: player.x,
                    y: player.y,
                    type: player.playerType,
                    timestamp: Date.now()
                });
            }
        }

        // ウィンドウリサイズ対応
        window.addEventListener('resize', () => {
            game.scale.resize(window.innerWidth, window.innerHeight);
        });

        // ゲームを開始
        const game = new Phaser.Game(config);
    </script>
</body>
</html>
