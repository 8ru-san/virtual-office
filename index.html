<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ãƒãƒ¼ãƒãƒ£ãƒ«ç´”å–«èŒ¶</title>
    <style>
        body {
            margin: 0;
            padding: 20px;
            background: linear-gradient(135deg, #8B4513 0%, #D2691E 50%, #CD853F 100%);
            font-family: 'Georgia', serif;
            min-height: 100vh;
        }
        #game-container {
            border: 4px solid #8B4513;
            border-radius: 15px;
            margin: 0 auto;
            display: block;
            box-shadow: 0 15px 35px rgba(139, 69, 19, 0.4);
            overflow: hidden;
        }
        h1 {
            text-align: center;
            color: #8B4513;
            text-shadow: 2px 2px 4px rgba(255,255,255,0.5);
            margin-bottom: 10px;
            font-family: 'Georgia', serif;
            font-size: 32px;
        }
        p {
            text-align: center;
            color: #654321;
            margin-bottom: 20px;
            font-style: italic;
        }
        .info-panel {
            background: rgba(255, 248, 220, 0.9);
            border: 2px solid #8B4513;
            border-radius: 10px;
            padding: 15px;
            margin: 20px auto;
            max-width: 800px;
            text-align: center;
            box-shadow: inset 0 2px 5px rgba(139, 69, 19, 0.2);
        }
        .cafe-title {
            color: #8B4513;
            font-weight: bold;
            font-size: 18px;
            margin-bottom: 10px;
        }
    </style>
</head>
<body>
    <h1>â˜• ãƒãƒ¼ãƒãƒ£ãƒ«ç´”å–«èŒ¶</h1>
    <p>ã‚†ã£ãŸã‚Šã¨ã—ãŸæ™‚é–“ã‚’éã”ã™æ†©ã„ã®å ´</p>
    
    <div class="info-panel">
        <div class="cafe-title">ğŸ›ï¸ æ˜­å’Œãƒ¬ãƒˆãƒ­ãªç´”å–«èŒ¶ç©ºé–“</div>
        çŸ¢å°ã‚­ãƒ¼ã§ç§»å‹•ã—ã¦ã€ãŠæ°—ã«å…¥ã‚Šã®å¸­ã§ãã¤ã‚ã„ã§ãã ã•ã„<br>
        <small>ã‚³ãƒ¼ãƒ’ãƒ¼ã®é¦™ã‚Šã¨å…±ã«ã€ä»²é–“ã¨ã®ç©ã‚„ã‹ãªã²ã¨ã¨ãã‚’</small>
    </div>
    
    <!-- Phaser.jsã‚’CDNã‹ã‚‰èª­ã¿è¾¼ã¿ -->
    <script src="https://cdn.jsdelivr.net/npm/phaser@3.70.0/dist/phaser.min.js"></script>
    
    <script type="module">
        // Firebase ã®è¨­å®šã¨åˆæœŸåŒ–
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.0.1/firebase-app.js";
        import { getDatabase, ref, set, onValue, push } from "https://www.gstatic.com/firebasejs/11.0.1/firebase-database.js";
        
        // Firebaseè¨­å®š
        const firebaseConfig = {
            apiKey: "AIzaSyA4i0HfjD3Bxnv80TCm7icQ6e20jss1ATs",
            authDomain: "virtual-office-40ff8.firebaseapp.com",
            databaseURL: "https://virtual-office-40ff8-default-rtdb.asia-southeast1.firebasedatabase.app",
            projectId: "virtual-office-40ff8",
            storageBucket: "virtual-office-40ff8.firebasestorage.app",
            messagingSenderId: "113452355413",
            appId: "1:113452355413:web:1e35e9d49282710171e9dc"
        };

        // Firebaseã‚’åˆæœŸåŒ–
        const app = initializeApp(firebaseConfig);
        const database = getDatabase(app);
        
        // ã‚²ãƒ¼ãƒ ã®åŸºæœ¬è¨­å®š
        const config = {
            type: Phaser.AUTO,
            width: 800,
            height: 600,
            backgroundColor: '#F5DEB3', // ãƒ™ãƒ¼ã‚¸ãƒ¥ã®æ¸©ã‹ã„èƒŒæ™¯
            parent: 'game-container',
            scene: {
                preload: preload,
                create: create,
                update: update
            }
        };

        let player;
        let cursors;
        let otherPlayers = {}; // ä»–ã®ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼ã‚’ç®¡ç†
        let playerId;

        function preload() {
            // ç´”å–«èŒ¶ã‚‰ã—ã„å„ªã—ã„è‰²åˆã„ã®ã‚¢ãƒã‚¿ãƒ¼
            this.add.graphics()
                .fillStyle(0x8B4513) // èŒ¶è‰²ã®æœ
                .fillRect(6, 12, 20, 28)
                .fillStyle(0xFFDBB3) // è‚Œè‰²ã®é¡”
                .fillCircle(16, 8, 8)
                .fillStyle(0x654321) // é«ª
                .fillCircle(16, 6, 9)
                .generateTexture('customer-1', 32, 48);
                
            this.add.graphics()
                .fillStyle(0x2F4F2F) // æ·±ç·‘ã®æœ
                .fillRect(6, 12, 20, 28)
                .fillStyle(0xFFDBB3) // è‚Œè‰²ã®é¡”
                .fillCircle(16, 8, 8)
                .fillStyle(0x8B4513) // èŒ¶é«ª
                .fillCircle(16, 6, 9)
                .generateTexture('customer-2', 32, 48);
                
            this.add.graphics()
                .fillStyle(0x483D8B) // ç´ºè‰²ã®æœ
                .fillRect(6, 12, 20, 28)
                .fillStyle(0xFFDBB3) // è‚Œè‰²ã®é¡”
                .fillCircle(16, 8, 8)
                .fillStyle(0x2F2F2F) // é»’é«ª
                .fillCircle(16, 6, 9)
                .generateTexture('customer-3', 32, 48);
                
            this.add.graphics()
                .fillStyle(0xB22222) // ãˆã‚“ã˜è‰²ã®æœ
                .fillRect(6, 12, 20, 28)
                .fillStyle(0xFFDBB3) // è‚Œè‰²ã®é¡”
                .fillCircle(16, 8, 8)
                .fillStyle(0x654321) // èŒ¶é«ª
                .fillCircle(16, 6, 9)
                .generateTexture('customer-4', 32, 48);

            // ç´”å–«èŒ¶ã®å®¶å…·ãƒ†ã‚¯ã‚¹ãƒãƒ£ã‚’ç”Ÿæˆ
            // ä¸¸ãƒ†ãƒ¼ãƒ–ãƒ«ï¼ˆå¤§ç†çŸ³é¢¨ï¼‰
            this.add.graphics()
                .fillStyle(0xF5F5DC)
                .fillCircle(35, 35, 35)
                .fillStyle(0xE6E6FA)
                .fillCircle(35, 35, 30)
                .fillStyle(0xD3D3D3)
                .fillCircle(35, 35, 25)
                .generateTexture('round-table', 70, 70);

            // æ¤…å­ï¼ˆãƒ¬ãƒˆãƒ­ãªèµ¤ã„æ¤…å­ï¼‰
            this.add.graphics()
                .fillStyle(0x8B4513) // æœ¨ã®è„š
                .fillRect(15, 35, 10, 15)
                .fillRect(25, 35, 10, 15)
                .fillStyle(0xDC143C) // èµ¤ã„ã‚¯ãƒƒã‚·ãƒ§ãƒ³
                .fillEllipse(25, 25, 30, 20)
                .fillStyle(0xB22222) // èƒŒã‚‚ãŸã‚Œ
                .fillRect(10, 10, 30, 25)
                .generateTexture('retro-chair', 50, 50);

            // ã‚«ã‚¦ãƒ³ã‚¿ãƒ¼
            this.add.graphics()
                .fillStyle(0x8B4513) // æœ¨ç›®èª¿
                .fillRect(0, 0, 400, 60)
                .fillStyle(0xA0522D)
                .fillRect(5, 5, 390, 50)
                .fillStyle(0xCD853F)
                .fillRect(10, 10, 380, 40)
                .generateTexture('counter', 400, 60);

            // è¦³è‘‰æ¤ç‰©ï¼ˆç´”å–«èŒ¶ã‚‰ã—ãï¼‰
            this.add.graphics()
                .fillStyle(0x8B4513) // é‰¢
                .fillRect(10, 40, 20, 15)
                .fillStyle(0x228B22) // è‘‰
                .fillEllipse(20, 25, 25, 30)
                .fillStyle(0x32CD32)
                .fillEllipse(20, 20, 20, 25)
                .generateTexture('plant-pot', 40, 55);

            // ã‚³ãƒ¼ãƒ’ãƒ¼ã‚«ãƒƒãƒ—ï¼ˆãƒ†ãƒ¼ãƒ–ãƒ«è£…é£¾ç”¨ï¼‰
            this.add.graphics()
                .fillStyle(0xFFFFFF) // ç™½ã„ã‚«ãƒƒãƒ—
                .fillEllipse(8, 8, 12, 8)
                .fillStyle(0x8B4513) // ã‚³ãƒ¼ãƒ’ãƒ¼
                .fillEllipse(8, 8, 8, 6)
                .fillStyle(0xD2B48C) // å—ã‘çš¿
                .fillEllipse(8, 12, 16, 4)
                .generateTexture('coffee-cup', 16, 16);
        }

        function create() {
            // ç´”å–«èŒ¶ã®æ¸©ã‹ã„é›°å›²æ°—ã‚’ä½œæˆ
            this.createCafeBackground();
            
            // ãƒ¦ãƒ‹ãƒ¼ã‚¯ãªãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼IDã‚’ç”Ÿæˆ
            playerId = 'player_' + Math.random().toString(36).substr(2, 9);
            
            // ãƒ©ãƒ³ãƒ€ãƒ ãªãŠå®¢ã•ã‚“ã‚¿ã‚¤ãƒ—ã‚’é¸æŠ
            const customerTypes = ['customer-1', 'customer-2', 'customer-3', 'customer-4'];
            const playerType = customerTypes[Math.floor(Math.random() * customerTypes.length)];
            
            // ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼ï¼ˆãŠå®¢ã•ã‚“ï¼‰ã‚’ä½œæˆ
            player = this.add.sprite(400, 300, playerType);
            player.playerId = playerId;
            player.playerType = playerType;
            player.setDepth(100); // ã‚¢ãƒã‚¿ãƒ¼ã‚’å‰é¢ã«è¡¨ç¤º
            
            // ã‚­ãƒ¼ãƒœãƒ¼ãƒ‰å…¥åŠ›ã‚’è¨­å®š
            cursors = this.input.keyboard.createCursorKeys();
            
            // UIè¦ç´ ã‚’è¿½åŠ ï¼ˆç´”å–«èŒ¶ã‚‰ã—ãï¼‰
            const headerBg = this.add.rectangle(400, 25, 800, 50, 0x8B4513, 0.8);
            headerBg.setStrokeStyle(2, 0x654321);
            
            this.add.text(20, 10, 'â˜• ç´”å–«èŒ¶ã€Œæ†©ã€', {
                fontSize: '20px',
                color: '#F5DEB3',
                fontFamily: 'Georgia, serif',
                fontWeight: 'bold'
            });
            
            this.add.text(20, 35, 'ã‚†ã£ãŸã‚Šã¨ãŠéã”ã—ãã ã•ã„', {
                fontSize: '12px',
                color: '#DEB887',
                fontFamily: 'Georgia, serif',
                fontStyle: 'italic'
            });
            
            // ãŠå®¢ã•ã‚“æ•°è¡¨ç¤º
            this.add.text(650, 15, `ãŠå®¢æ§˜: ${Object.keys(otherPlayers).length + 1}å`, {
                fontSize: '14px',
                color: '#F5DEB3',
                fontFamily: 'Georgia, serif'
            });
            
            // Firebaseã§ä»–ã®ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼ã®ä½ç½®ã‚’ç›£è¦–
            const playersRef = ref(database, 'players');
            onValue(playersRef, (snapshot) => {
                const players = snapshot.val();
                if (players) {
                    Object.keys(players).forEach(id => {
                        if (id !== playerId) {
                            updateOtherPlayer.call(this, id, players[id]);
                        }
                    });
                    
                    // å­˜åœ¨ã—ãªã„ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼ã‚’å‰Šé™¤
                    Object.keys(otherPlayers).forEach(id => {
                        if (!players[id]) {
                            if (otherPlayers[id]) {
                                otherPlayers[id].destroy();
                                if (otherPlayers[id].shadowCircle) {
                                    otherPlayers[id].shadowCircle.destroy();
                                }
                                delete otherPlayers[id];
                            }
                        }
                    });
                }
            });
        }

        // ç´”å–«èŒ¶ã®èƒŒæ™¯ã‚’ä½œæˆã™ã‚‹é–¢æ•°
        Phaser.Scene.prototype.createCafeBackground = function() {
            // ãƒ™ãƒ¼ã‚¹ã®åºŠï¼ˆæ¸©ã‹ã„ãƒ•ãƒ­ãƒ¼ãƒªãƒ³ã‚°ï¼‰
            this.add.rectangle(400, 300, 800, 600, 0xDEB887);
            
            // ãƒ•ãƒ­ãƒ¼ãƒªãƒ³ã‚°ã®æœ¨ç›®æ¨¡æ§˜
            for (let i = 0; i < 600; i += 80) {
                this.add.line(400, i + 40, 0, 0, 800, 0, 0xCD853F, 0.3).setOrigin(0.5, 0.5);
            }
            for (let i = 0; i < 800; i += 120) {
                this.add.line(i + 60, 300, 0, 0, 0, 600, 0xCD853F, 0.2).setOrigin(0.5, 0.5);
            }
            
            // ã‚«ã‚¦ãƒ³ã‚¿ãƒ¼ï¼ˆä¸Šéƒ¨ï¼‰
            this.add.image(400, 90, 'counter').setDepth(1);
            this.add.text(250, 70, 'ãƒã‚¹ã‚¿ãƒ¼å¸­', {
                fontSize: '14px',
                color: '#8B4513',
                fontFamily: 'Georgia, serif'
            });
            
            // ãƒ†ãƒ¼ãƒ–ãƒ«ã¨æ¤…å­ã®é…ç½®ï¼ˆç´”å–«èŒ¶ã‚‰ã—ãï¼‰
            // å·¦å´ã®ãƒ†ãƒ¼ãƒ–ãƒ«ç¾¤
            this.add.image(150, 200, 'round-table').setDepth(1);
            this.add.image(130, 170, 'retro-chair').setDepth(2);
            this.add.image(170, 170, 'retro-chair').setDepth(2);
            this.add.image(130, 230, 'retro-chair').setDepth(2);
            this.add.image(170, 230, 'retro-chair').setDepth(2);
            this.add.image(150, 200, 'coffee-cup').setDepth(3);
            
            this.add.image(150, 350, 'round-table').setDepth(1);
            this.add.image(130, 320, 'retro-chair').setDepth(2);
            this.add.image(170, 320, 'retro-chair').setDepth(2);
            this.add.image(130, 380, 'retro-chair').setDepth(2);
            this.add.image(170, 380, 'retro-chair').setDepth(2);
            
            // ä¸­å¤®ã®ãƒ†ãƒ¼ãƒ–ãƒ«ç¾¤
            this.add.image(400, 250, 'round-table').setDepth(1);
            this.add.image(380, 220, 'retro-chair').setDepth(2);
            this.add.image(420, 220, 'retro-chair').setDepth(2);
            this.add.image(380, 280, 'retro-chair').setDepth(2);
            this.add.image(420, 280, 'retro-chair').setDepth(2);
            this.add.image(400, 250, 'coffee-cup').setDepth(3);
            
            this.add.image(400, 400, 'round-table').setDepth(1);
            this.add.image(380, 370, 'retro-chair').setDepth(2);
            this.add.image(420, 370, 'retro-chair').setDepth(2);
            this.add.image(380, 430, 'retro-chair').setDepth(2);
            this.add.image(420, 430, 'retro-chair').setDepth(2);
            
            // å³å´ã®ãƒ†ãƒ¼ãƒ–ãƒ«ç¾¤
            this.add.image(650, 200, 'round-table').setDepth(1);
            this.add.image(630, 170, 'retro-chair').setDepth(2);
            this.add.image(670, 170, 'retro-chair').setDepth(2);
            this.add.image(630, 230, 'retro-chair').setDepth(2);
            this.add.image(670, 230, 'retro-chair').setDepth(2);
            this.add.image(650, 200, 'coffee-cup').setDepth(3);
            
            this.add.image(650, 350, 'round-table').setDepth(1);
            this.add.image(630, 320, 'retro-chair').setDepth(2);
            this.add.image(670, 320, 'retro-chair').setDepth(2);
            this.add.image(630, 380, 'retro-chair').setDepth(2);
            this.add.image(670, 380, 'retro-chair').setDepth(2);
            
            // è¦³è‘‰æ¤ç‰©ã§é›°å›²æ°—ä½œã‚Š
            this.add.image(50, 150, 'plant-pot').setDepth(1);
            this.add.image(750, 150, 'plant-pot').setDepth(1);
            this.add.image(50, 450, 'plant-pot').setDepth(1);
            this.add.image(750, 450, 'plant-pot').setDepth(1);
            
            // çª“éš›ã®ãƒ©ã‚¤ãƒ³ï¼ˆé›°å›²æ°—ä½œã‚Šï¼‰
            this.add.rectangle(400, 570, 700, 8, 0x8B4513, 0.3);
            this.add.text(350, 545, 'çª“éš›ã®å¸­', {
                fontSize: '12px',
                color: '#8B4513',
                fontFamily: 'Georgia, serif',
                fontStyle: 'italic'
            });
        };

        function updateOtherPlayer(id, data) {
            if (!otherPlayers[id]) {
                // æ–°ã—ã„ãŠå®¢ã•ã‚“ã‚’ä½œæˆ
                otherPlayers[id] = this.add.sprite(data.x, data.y, data.type || 'customer-1');
                otherPlayers[id].setAlpha(0.9);
                otherPlayers[id].setDepth(100);
                
                // è¶³å…ƒã«è–„ã„å½±ã‚’è¿½åŠ ï¼ˆå­˜åœ¨æ„Ÿã®ãŸã‚ï¼‰
                const shadowCircle = this.add.circle(data.x, data.y + 20, 12, 0x000000, 0.1);
                shadowCircle.setDepth(50);
                otherPlayers[id].shadowCircle = shadowCircle;
                
            } else {
                // æ—¢å­˜ã®ãŠå®¢ã•ã‚“ã®ä½ç½®ã‚’æ›´æ–°
                otherPlayers[id].x = data.x;
                otherPlayers[id].y = data.y;
                if (otherPlayers[id].shadowCircle) {
                    otherPlayers[id].shadowCircle.x = data.x;
                    otherPlayers[id].shadowCircle.y = data.y + 20;
                }
            }
        }

        function update() {
            // ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼ã®ç§»å‹•å‡¦ç†
            const speed = 2; // ç´”å–«èŒ¶ã‚‰ã—ãã‚†ã£ãã‚Šã¨
            let moved = false;
            
            if (cursors.left.isDown) {
                player.x -= speed;
                moved = true;
            }
            if (cursors.right.isDown) {
                player.x += speed;
                moved = true;
            }
            if (cursors.up.isDown) {
                player.y -= speed;
                moved = true;
            }
            if (cursors.down.isDown) {
                player.y += speed;
                moved = true;
            }
            
            // ç”»é¢å¤–ã«å‡ºãªã„ã‚ˆã†ã«åˆ¶é™
            player.x = Phaser.Math.Clamp(player.x, 24, 776);
            player.y = Phaser.Math.Clamp(player.y, 80, 576);
            
            // å‹•ã„ãŸå ´åˆã€Firebaseã«ä½ç½®ã‚’é€ä¿¡
            if (moved) {
                const playerRef = ref(database, 'players/' + playerId);
                set(playerRef, {
                    x: player.x,
                    y: player.y,
                    type: player.playerType,
                    timestamp: Date.now()
                });
            }
        }

        // ã‚²ãƒ¼ãƒ ã‚’é–‹å§‹
        const game = new Phaser.Game(config);
    </script>
</body>
</html>
